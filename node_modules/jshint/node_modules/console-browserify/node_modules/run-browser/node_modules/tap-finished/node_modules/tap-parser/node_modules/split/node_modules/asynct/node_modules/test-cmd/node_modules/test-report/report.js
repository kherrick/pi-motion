

module.exports = Reporter

var stati = 
    { started: 'started'
    , success: 'success'
    , failure: 'failure'
    ,   error: 'error' }
  , order = [stati.success, stati.failure, stati.error]
  , assert = require('assert')

Reporter.status = stati

function update(old, newer){
  var o = order.indexOf(old)
    , n = order.indexOf(newer)
    
    return order[o > n ? o : n]
}

function min (array, func) {
  var m = 'success'
  for(var i in array) {
    var n = func(array[i],i,array)
    if(n && n < m)
      m = n
  }
  return m
}

function getStatus (test) {
  var m = min(test.failures,function (e) {
        if(e && e.name && e.name === "AssertionError")
          return stati.failure
        return stati.error
      })
    , n = test.tests ? min (test.tests, function (e) {
        return getStatus(e)
      }) : 'success'

  return n < m ? n : m
}

function failureCount (test) {
  return test.failures.length + 
    ( test.tests ? test.tests.map(failureCount).reduce(function (x, y) {
          return x + y